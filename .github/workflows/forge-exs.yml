name: Forge $EXS - Œ©‚Ä≤ Œî18 Proof Validator


# This workflow serves as the "Forge Trigger" for the Excalibur $EXS Protocol
# It runs the Œ©‚Ä≤ Œî18 miner to validate incoming "Claim" Pull Requests
# before they can be merged into Camelot (main branch)

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  validate-proof:
    name: Validate Œ©‚Ä≤ Œî18 Proof
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: Extract proof from PR description
        id: extract_proof
        run: |
          # Extract proof hash from PR body
          PROOF=$(echo "${{ github.event.pull_request.body }}" | grep -oP "(?<=PROOF:\s)[a-f0-9]{64}" || echo "")
          echo "proof=$PROOF" >> $GITHUB_OUTPUT
          
          if [ -z "$PROOF" ]; then
            echo "‚ùå No valid proof found in PR description"
            echo "Please include 'PROOF: <hash>' in your PR description"
            exit 1
          fi
          
          echo "‚úÖ Proof extracted: $PROOF"
      
      - name: Verify Œ©‚Ä≤ Œî18 difficulty
        id: verify_difficulty
        run: |
          PROOF="${{ steps.extract_proof.outputs.proof }}"
          DIFFICULTY=4
          
          # Check if proof has required leading zeros (exactly 4)
          if echo "$PROOF" | grep -q "^0000"; then
            echo "‚úÖ Proof meets difficulty target (4 leading zeros)"
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Proof does not meet difficulty target"
            echo "Required: 4 leading zeros"
            echo "Received proof: $PROOF"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Comment on PR
        if: steps.verify_difficulty.outputs.valid == 'true'
        uses: actions/github-script@v7
        with:
          script: |
    paths:
      - 'claims/**'
      - 'forges/**'
  workflow_dispatch:
    inputs:
      axiom:
        description: 'The 13-word Prophecy Axiom'
        required: true
        default: 'sword legend pull magic kingdom artist stone destroy forget fire steel honey question'
      difficulty:
        description: 'Mining difficulty (leading zeros)'
        required: false
        default: '4'

env:
  AXIOM: "sword legend pull magic kingdom artist stone destroy forget fire steel honey question"
  DEFAULT_DIFFICULTY: 4

jobs:
  validate-prophecy:
    name: üîÆ Validate Prophecy Axiom
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Verify Axiom Format
        run: |
          echo "üîÆ Validating the Prophecy Axiom..."
          AXIOM_WORD_COUNT=$(echo "${{ env.AXIOM }}" | wc -w)
          
          if [ "$AXIOM_WORD_COUNT" -ne 13 ]; then
            echo "‚ùå Invalid Axiom: Must contain exactly 13 words"
            exit 1
          fi
          
          echo "‚úÖ Axiom validation passed: 13 words confirmed"

  run-tetra-pow-miner:
    name: ‚öîÔ∏è Run Œ©‚Ä≤ Œî18 Miner
    runs-on: ubuntu-latest
    needs: validate-prophecy
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Dependencies
        run: |
          echo "üì¶ Installing Python dependencies..."
          python -m pip install --upgrade pip
          # The miner uses only standard library, but we'll verify Python version
          python --version
      
      - name: Run Tetra-PoW Miner
        id: forge
        run: |
          echo "‚öîÔ∏è Drawing the Sword - Initiating Œ©‚Ä≤ Œî18 mining..."
          echo "üîÆ Axiom: ${{ env.AXIOM }}"
          echo "‚öñÔ∏è Difficulty: ${{ env.DEFAULT_DIFFICULTY }}"
          echo ""
          
          # Run the miner
          python pkg/miner/tetra_pow_miner.py > forge_output.txt 2>&1
          
          # Display results
          cat forge_output.txt
          
          # Check if forge was successful
          if grep -q "FORGE SUCCESSFUL" forge_output.txt; then
            echo "‚úÖ Forge completed successfully!"
            echo "forge_success=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Forge failed - no valid hash found"
            echo "forge_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Upload Forge Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: forge-results
          path: forge_output.txt
          retention-days: 30
      
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('forge_output.txt', 'utf8');
            
            const comment = `## ‚öîÔ∏è Forge Validation Results
            
            The Œ©‚Ä≤ Œî18 Tetra-PoW miner has completed validation:
            
            \`\`\`
            ${output}
            \`\`\`
            
            ‚úÖ **Forge Status:** ${{ steps.forge.outputs.forge_success == 'true' && 'SUCCESS' || 'FAILED' }}
            
            ---
            *Excalibur $EXS Protocol - "Only the worthy may draw the sword"*
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ **Œ©‚Ä≤ Œî18 Proof Verified**\n\n' +
                    'Proof Hash: `${{ steps.extract_proof.outputs.proof }}`\n' +
                    'Difficulty: 4 leading zeros ‚úì\n\n' +
                    'Your forge will be recorded in the claims ledger upon merge.'
            })

  record-claim:
    name: Record Forge Claim
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 2
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: Check for merge commit
        id: check_merge
        run: |
          # Check if this is a merge commit from a PR
          COMMIT_MSG=$(git log -1 --pretty=%B)
          
          if echo "$COMMIT_MSG" | grep -q "Merge pull request"; then
            PR_NUM=$(echo "$COMMIT_MSG" | grep -oP "(?<=#)\d+" | head -1)
            echo "is_merge=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
            echo "Found merge from PR #$PR_NUM"
          else
            echo "is_merge=false" >> $GITHUB_OUTPUT
            echo "Not a PR merge commit, skipping claim recording"
          fi
      
      - name: Extract claim data
        id: extract_claim
        if: steps.check_merge.outputs.is_merge == 'true'
        run: |
          # For automated recording, claims should be in commit message
          # Format: PROOF: <hash> ADDRESS: <address>
          COMMIT_MSG=$(git log -1 --pretty=%B)
          
          PROOF=$(echo "$COMMIT_MSG" | grep -oP "(?<=PROOF:\s)[a-f0-9]{64}" || echo "")
          ADDRESS=$(echo "$COMMIT_MSG" | grep -oP "(?<=ADDRESS:\s)[a-z0-9]{62,90}" || echo "")
          
          echo "proof=$PROOF" >> $GITHUB_OUTPUT
          echo "address=$ADDRESS" >> $GITHUB_OUTPUT
          
          if [ -z "$PROOF" ] || [ -z "$ADDRESS" ]; then
            echo "‚ö†Ô∏è  No proof or address found in commit message"
            echo "‚ö†Ô∏è  Claims must be recorded manually"
            exit 0
          fi
      
      - name: Update claims ledger
        if: steps.check_merge.outputs.is_merge == 'true' && steps.extract_claim.outputs.proof != ''
        run: |
          # Create ledger directory if it doesn't exist
          mkdir -p ledger
          
          # Initialize claims.json if it doesn't exist
          if [ ! -f ledger/claims.json ]; then
            echo '{"claims": [], "total_forged": 0, "total_rewards": 0}' > ledger/claims.json
          fi
          
          # Load tokenomics
          REWARD_PER_FORGE=$(jq -r '.RewardPerForge' pkg/economy/tokenomics.json)
          
          # Create new claim entry
          CLAIM=$(jq -n \
            --arg pr "${{ steps.check_merge.outputs.pr_number }}" \
            --arg proof "${{ steps.extract_claim.outputs.proof }}" \
            --arg address "${{ steps.extract_claim.outputs.address }}" \
            --arg reward "$REWARD_PER_FORGE" \
            --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --arg merger "${{ github.actor }}" \
            '{
              pr_number: ($pr | tonumber),
              proof_hash: $proof,
              taproot_address: $address,
              reward_exs: ($reward | tonumber),
              timestamp: $timestamp,
              merged_by: $merger
            }')
          
          # Append claim to ledger
          jq --argjson claim "$CLAIM" \
             --argjson reward "$REWARD_PER_FORGE" \
             '.claims += [$claim] | 
              .total_forged += 1 | 
              .total_rewards += ($reward | tonumber)' \
             ledger/claims.json > ledger/claims.json.tmp
          
          mv ledger/claims.json.tmp ledger/claims.json
          
          echo "‚úÖ Claim recorded in ledger"
          echo "üìä Total Forged: $(jq -r '.total_forged' ledger/claims.json)"
          echo "üí∞ Total Rewards: $(jq -r '.total_rewards' ledger/claims.json) $EXS"
      
      - name: Commit and push ledger update
        if: steps.check_merge.outputs.is_merge == 'true' && steps.extract_claim.outputs.proof != ''
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add ledger/claims.json
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "üó°Ô∏è Record forge claim from PR #${{ steps.check_merge.outputs.pr_number }}"
            git push
            
            echo "‚úÖ Ledger updated and pushed to main branch"
          fi
              body: comment
            });

  process-forge-hpp1:
    name: üî® Process Forge with HPP-1
    runs-on: ubuntu-latest
    needs: run-tetra-pow-miner
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Run EXS Foundry
        run: |
          echo "üî® Processing forge with HPP-1 protocol..."
          echo "‚ö° Iterations: 600,000 PBKDF2-HMAC-SHA512"
          echo ""
          
          # Run the foundry
          python pkg/foundry/exs_foundry.py > foundry_output.txt 2>&1
          
          # Display results
          cat foundry_output.txt
      
      - name: Upload Foundry Results
        uses: actions/upload-artifact@v4
        with:
          name: foundry-results
          path: foundry_output.txt
          retention-days: 30

  validate-treasury:
    name: üí∞ Validate Treasury Fees
    runs-on: ubuntu-latest
    needs: process-forge-hpp1
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Validate Fee Structure
        run: |
          echo "üí∞ Validating Treasury Fee Structure..."
          echo ""
          echo "Expected Fees:"
          echo "  - Treasury Fee: 1% of forge reward"
          echo "  - Forge Fee: 0.0001 BTC"
          echo ""
          
          # Parse tokenomics.json
          if [ -f "pkg/economy/tokenomics.json" ]; then
            echo "‚úÖ Tokenomics configuration found"
            
            # Validate fee structure exists
            if grep -q "treasury_fee" pkg/economy/tokenomics.json; then
              echo "‚úÖ Treasury fee configuration validated"
            else
              echo "‚ùå Treasury fee configuration missing"
              exit 1
            fi
            
            if grep -q "forge_fee" pkg/economy/tokenomics.json; then
              echo "‚úÖ Forge fee configuration validated"
            else
              echo "‚ùå Forge fee configuration missing"
              exit 1
            fi
          else
            echo "‚ùå Tokenomics configuration not found"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ All fee validations passed"

  forge-summary:
    name: üìä Forge Summary
    runs-on: ubuntu-latest
    needs: [validate-prophecy, run-tetra-pow-miner, process-forge-hpp1, validate-treasury]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "# üèÜ Excalibur $EXS Forge Validation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Prophecy Axiom validated" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Œ©‚Ä≤ Œî18 mining completed (128 rounds)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ HPP-1 processing completed (600,000 iterations)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Treasury fees validated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Protocol Info" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Algorithm:** Œ©‚Ä≤ Œî18 Tetra-PoW" >> $GITHUB_STEP_SUMMARY
          echo "- **Rounds:** 128 nonlinear transformations" >> $GITHUB_STEP_SUMMARY
          echo "- **Hardening:** HPP-1 (600,000 PBKDF2 iterations)" >> $GITHUB_STEP_SUMMARY
          echo "- **Difficulty:** ${{ env.DEFAULT_DIFFICULTY }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Reward:** 50 \$EXS (49.5 to miner, 0.5 to treasury)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Lead Architect: Travis D Jones (holedozer@gmail.com)*" >> $GITHUB_STEP_SUMMARY
